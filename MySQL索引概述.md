# MySQL索引概述

---

[参考链接：MySQL索引的数据结构-B+树介绍](https://www.cnblogs.com/nickchen121/p/11152523.html)

---

## B+Tree的性质

1. ***`索引字段要尽量小`*** ：IO次数取决于B+Tree的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有h=㏒(m+1)N，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低，B+Tree要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高，`当数据项等于1时将会退化成线性表`

2. ***`索引的最左匹配原则`*** ：当B+Tree的数据项是复合的数据结构，比如(name,age,sex)的时候，B+Tree是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，B+Tree会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，B+Tree就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询，比如当(张三,F)这样的数据来检索时，B+Tree可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性

## 聚集索引和辅助索引

在数据库中，B+树的高度一般都在24层，这也就是说查找某一个键值的行记录时最多只需要2到4次IO
数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index）
聚集索引与辅助索引相同的是：不管是聚集索引还是辅助索引，其内部都是B+树的形式，即高度是平衡的，叶子结点存放着所有的数据
聚集索引与辅助索引不同的是：叶子结点存放的是否是一整行的信息

### 聚集索引

InnoDB存储引擎表是索引组织表，即表中数据按照主键顺序存放
聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子结点存放的即为整张表的行记录数据，也将聚集索引的叶子结点称为数据页
聚集索引的这个特性决定了索引组织表中数据也是索引的一部分，同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接
如果未定义主键，MySQL取第一个唯一索引（unique）而且只含非空列（NOT NULL）作为主键，InnoDB使用它作为聚簇索引，如果没有这样的列，InnoDB就自己产生一个这样的ID值，它有六个字节，而且是隐藏的，使其作为聚簇索引
由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引
在多数情况下，查询优化器倾向于采用聚集索引，因为聚集索引能够在B+树索引的叶子节点上直接找到数据
此外由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值得查询
对主键的排序查找和范围查找速度非常快，叶子节点的数据就是用户所要查询的数据
范围查询（range query），即如果要查找主键某一范围内的数据，通过叶子节点的上层中间节点就可以得到页的范围，之后直接读取数据页即可

### 辅助索引

表中除了聚集索引外其他索引都是辅助索引（Secondary Index，也称为非聚集索引），与聚集索引的区别是： ***`辅助索引的叶子节点不包含行记录的全部数据`***
叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含一个书签（bookmark），该书签用来告诉InnoDB存储引擎去哪里可以找到与索引相对应的行数据
由于InnoDB存储引擎是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是 ***`相应行数据的聚集索引键`***
辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引，但只能有一个聚集索引
当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶子级别的指针获得指向主键索引的主键，然后再通过主键索引来找到一个完整的行记录（即回表）

## 聚集索引和非聚集索引的区别

***`聚集索引：`***
    1. 记录的索引顺序与物理顺序相同，因此更适合between and和order by操作
    2. 叶子结点直接对应数据
    3. 每张表只能创建一个聚集索引

***`非聚集索引：`***
    1. 索引顺序和物理顺序无关
    2. 叶子结点不直接指向数据，而是指向主键
    3. 每张表可以有多个非聚集索引，需要更多磁盘和内容
    4. 多个索引会影响insert和update的速度
